R code works ok, but is not final